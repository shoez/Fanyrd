<!doctype html>
<head>
  <meta charset="utf-8">

  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0rc1/jquery.mobile-1.0rc1.min.css" />
	<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.0rc1/jquery.mobile-1.0rc1.min.js"></script>



<script src="/socket.io/socket.io.js"></script>

<script>

$(document).ready(function() {

	var clientId = parseInt(Math.random()*1000);
	var talkId = '{{ talkId }}' || 'TRIALID';
	
	var connected = false;
	
	$('.ui-slider').hide();
	
	var socket = io.connect(document.domain, {
		'reconnect': true,
		'reconnection delay': 500,
		'max reconnection attempts': 10
	});
	
    socket.on('connect', function () {
    	console.log('connected');
    	connected = true;
    	
    	socket.emit('setClientId', clientId);
    	
    	socket.on('clientReady', function onReady() {
			console.log('client ready, waiting for talk ready');
			socket.emit('setTalkId', talkId);
    	});
    	
    	socket.on('talkReady', function onReady() {
    		$('.ui-slider').show();
    		socket.emit('rate', {s:$('#slider').val(), id:clientId, t:talkId});
    	});
    	
    	socket.on('rating', function updateRating(data) {
    		var json = $.parseJSON(data);
    		$('#rating')[0].innerHTML =  (json.s / json.c) + " (" + json.s + ")";
    		$('#clients')[0].innerHTML = json.c;
    	});
    	
    	socket.on('global.rating', function(data) {
    		var json = $.parseJSON(data);
    		$('#global-rating-rating')[0].innerHTML = json.rating;
    		$('#global-rating-didSet')[0].innerHTML = json.didSet;
    	});
    	
    	socket.on('global.client.disconnect', function(data) {
    		var json = $.parseJSON(data);
    		$('#global-client-disconnect-disconnected')[0].innerHTML = $('#global-client-disconnect-disconnected')[0].innerHTML + ", " + json.disconnected;
			$('#global-client-disconnect-score')[0].innerHTML = $('#global-client-disconnect-score')[0].innerHTML + ", " + json.score;    		
    	});
    	
    	
		socket.on('disconnect', function() {
		  	connected = false;
		});
    	
    });	
	
	var preventTransmit = false;
	
	var sliderFun = function() {
		if (!connected) {
			return;
		}
	    var currentVal = $('#slider').val();
    	socket.emit('rate', {s:parseInt(currentVal), id:clientId, t:talkId});	
	};
	
	$('.ui-slider').live('mouseup', sliderFun);
	$('.ui-slider').live('touchend', sliderFun);
	
	//$('.ui-slider').live('slide', sliderFun);
	//$('.ui-slider').live('change', sliderFun);
	$('#slider').bind('slide', sliderFun);

});


$(document).unload(function() {
	socket.emit('disconnectClient', {clientId: clientId, talkId: talkId});
});

</script>



  
</head>

<body>

<div data-role="page" class="type-index">




	<div data-role="content">





<div data-role="fieldcontain">
   <label for="slider">Input slider:</label>
   <input type="range" name="slider" id="slider" value="50" min="0" max="100"  />
</div>

<div>
	<p>Clients: <span id="clients">0</span></p>
	<p>Rating: <span id="rating">0</span></p>
	
	<h2>Global</h2>
	<p>Rating: <span id="global-rating-rating">0</span></p>
	<p>Did Set: <span id="global-rating-didSet">0</span></p>

	<h2>Disconnects</h2>
	<p>Just disconnected: <span id="global-client-disconnect-disconnected"></span></p>
	<p>Disconnected Score: <span id="global-client-disconnect-score"></span></p>
</div>






	</div><!-- /content -->
</div><!-- /page -->



</body>
</html>

